<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Servis CanlÄ± Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; background:#111; color:white; text-align:center; margin:0; }
h2 { margin-top:15px; }
button {
  padding:12px 20px;
  margin:8px;
  border:none;
  border-radius:8px;
  font-size:15px;
  cursor:pointer;
}
.bus { background:#e74c3c; color:white; }
.passenger { background:#3498db; color:white; }
.board { background:#2ecc71; color:white; }
#map { height:400px; width:100%; margin-top:10px; }
#status { margin-top:10px; font-size:18px; }
</style>
</head>
<body>

<h2>ğŸš Servis CanlÄ± Takip</h2>

<button class="bus" onclick="startBus()">Servis YayÄ±nÄ± BaÅŸlat</button>
<button class="passenger" onclick="startPassenger()">Yolcu Takibi BaÅŸlat</button>
<button class="board" onclick="boardBus()">Bindim</button>

<div id="status">Durum: Bekleniyor</div>
<div id="map"></div>

<audio id="alarmSound">
<source src="https://www.soundjay.com/buttons/sounds/beep-07.mp3">
</audio>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyXW06DUAGDVhpTmUIoLH5ZY5pxaklOP4"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_dJZyISsd1DtR2cWw8VjSSBNTbdeS0xw",
  authDomain: "servistakip-e5926.firebaseapp.com",
  databaseURL: "https://servistakip-e5926-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "servistakip-e5926",
  storageBucket: "servistakip-e5926.firebasestorage.app",
  messagingSenderId: "278744315160",
  appId: "1:278744315160:web:21826565505ee6d2b51a6d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map = new google.maps.Map(document.getElementById("map"), {
    zoom: 15,
    center: { lat: 39.9208, lng: 32.8541 }
});

let busMarker = null;
let passengerMarker = null;
let passengerLocation = null;
let alarmPlayed = false;

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI/180;
    const Ï†2 = lat2 * Math.PI/180;
    const Î”Ï† = (lat2-lat1) * Math.PI/180;
    const Î”Î» = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// ğŸš SERVÄ°S KONUM YAYINI
window.startBus = function() {

    navigator.geolocation.watchPosition((pos) => {

        const location = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
        };

        set(ref(db, 'bus/location'), location);

        if (!busMarker) {
            busMarker = new google.maps.Marker({
                position: location,
                map: map,
                label: "ğŸš"
            });
        } else {
            busMarker.setPosition(location);
        }

        map.setCenter(location);

        document.getElementById("status").innerText =
            "Servis yayÄ±n yapÄ±yor...";

    }, (err)=> {
        alert("Konum izni ver!");
    }, { enableHighAccuracy: true });

}


// ğŸ‘¤ YOLCU TAKÄ°BÄ°
window.startPassenger = function() {

    navigator.geolocation.getCurrentPosition((pos) => {

        passengerLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
        };

        passengerMarker = new google.maps.Marker({
            position: passengerLocation,
            map: map,
            label: "ğŸ "
        });

        map.setCenter(passengerLocation);

        onValue(ref(db, 'bus/location'), (snapshot) => {

            const bus = snapshot.val();
            if (!bus) return;

            if (!busMarker) {
                busMarker = new google.maps.Marker({
                    position: bus,
                    map: map,
                    label: "ğŸš"
                });
            } else {
                busMarker.setPosition(bus);
            }

            let distance = getDistance(
                passengerLocation.lat,
                passengerLocation.lng,
                bus.lat,
                bus.lng
            );

            document.getElementById("status").innerText =
                "Servis mesafesi: " + Math.round(distance) + " metre";

            if (distance <= 200 && !alarmPlayed) {
                document.getElementById("alarmSound").play();
                alert("ğŸš Servis yaklaÅŸtÄ±!");
                alarmPlayed = true;
            }

        });

    }, ()=> {
        alert("Konum izni ver!");
    });

}


// ğŸ”˜ BÄ°NDÄ°M BUTONU
window.boardBus = function() {
    alarmPlayed = true;
    document.getElementById("status").innerText =
        "Servise bindildi. Alarm kapandÄ±.";
}

</script>

</body>
</html>

